name: CI - Dev - FluidAttacks SAST + Semgrep
on:
  workflow_dispatch: {}
  pull_request: {}
  push:
    branches:
      - main
      - master

jobs:
name: CI - FluidAttacks (SAST + SCA) - CSV before fail
on:
  workflow_dispatch: {}
  pull_request: {}
  push:
    branches:
      - main
      - master

jobs:
  scans-and-report:
    name: FluidAttacks scans (SAST + SCA) + Semgrep
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare reports directory
        run: mkdir -p analysis/report

      - name: Run FluidAttacks SAST (strict) and export CSV
        id: run_sast
        run: |
          docker run --rm -v "$GITHUB_WORKSPACE":/workspace -w /workspace docker.io/fluidattacks/sast:latest sh -c "sast --strict scan . --format csv --output analysis/report/fluidattacks_sast_results.csv" || true
          echo "exit_code=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Run FluidAttacks SCA (strict) and export CSV
        id: run_sca
        run: |
          docker run --rm -v "$GITHUB_WORKSPACE":/workspace -w /workspace docker.io/fluidattacks/sca:latest sh -c "sca --strict scan . --format csv --output analysis/report/fluidattacks_sca_results.csv" || true
          echo "exit_code=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: List generated CSV files
        run: |
          ls -la analysis/report || echo "No report files generated"

      - name: Upload FluidAttacks CSV artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fluidattacks-csv-results
          path: analysis/report

      - name: Run Semgrep CI and capture exit code
        id: run_semgrep
        run: |
          docker run --rm -v "$GITHUB_WORKSPACE":/workspace -w /workspace semgrep/semgrep sh -c "semgrep ci"
          echo "exit_code=$?" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Final check - fail if any tool found issues
        run: |
          sast_code="${{ steps.run_sast.outputs.exit_code }}"
          sca_code="${{ steps.run_sca.outputs.exit_code }}"
          semgrep_code="${{ steps.run_semgrep.outputs.exit_code }}"
          echo "SAST exit: $sast_code, SCA exit: $sca_code, Semgrep exit: $semgrep_code"
          if [ "$sast_code" != "0" ] || [ "$sca_code" != "0" ] || [ "$semgrep_code" != "0" ]; then
            echo "::error::One or more scanners reported issues. See CSV artifacts and Semgrep output."
            exit 1
          fi
        # Keep this step blocking so the job fails after artifacts are uploaded if issues exist

      - name: FluidAttacks SAST (dev, non-blocking)
        uses: docker://docker.io/fluidattacks/sast:latest
        with:
          args: sast scan /github/workspace
        continue-on-error: true

      - name: Semgrep (dev, non-blocking)
        uses: returntocorp/semgrep-action@v1
        with:
          config: p/ci
        continue-on-error: true

      - name: Dev summary
        run: |
          echo "Dev scans completed. Findings won't fail the workflow (non-blocking)."
